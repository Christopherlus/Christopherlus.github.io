<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fellowship Trajectories</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        /* CSS RESET & VARIABLES */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e1e4e8;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        /* LAYOUT CONTAINER */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            font-weight: 700;
            font-size: 2.2rem;
            letter-spacing: -0.5px;
        }

        p.subtitle {
            color: #666;
            margin-top: 8px;
            font-weight: 300;
            font-size: 1.1rem;
        }

        /* CONTROLS AREA */
        .controls-wrapper {
            background-color: #fafbfc;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; 
            gap: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            color: #7f8c8d;
        }

        select {
            padding: 10px 12px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:hover {
            border-color: var(--accent-color);
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* EXPLAINER NOTE */
        .chart-note {
            font-size: 0.9rem;
            color: #636e72;
            background-color: #fff;
            border: 1px solid #dfe6e9;
            border-left: 4px solid #b2bec3;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            line-height: 1.5;
        }

        /* STATS BOX */
        .stats-box {
            background: linear-gradient(135deg, #eef2f3 0%, #ffffff 100%);
            border-left: 4px solid var(--accent-color);
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 30px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            color: #444;
            box-shadow: var(--shadow);
            white-space: pre-wrap;
        }
        
        /* CHART AREA */
        #sankey-diagram {
            width: 100%;
            height: 700px; 
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 40px;
            /* Added min-height to prevent collapse during redraw */
            min-height: 700px;
        }

        /* --- NEW TABLE STYLES --- */
        .tables-section {
            border-top: 2px solid var(--border-color);
            padding-top: 30px;
            margin-bottom: 40px;
        }
        
        .section-header {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.8rem;
            text-align: center;
        }

        .program-block {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .program-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .table-wrapper h3 {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        td.count-col {
            width: 60px;
            text-align: center;
            font-weight: bold;
            color: var(--accent-color);
        }

        .empty-msg {
            color: #999;
            font-style: italic;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        /* FOOTER */
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.85rem;
            color: #95a5a6;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        /* RESPONSIVE TWEAKS */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .controls-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 20px;
            }
            h1 {
                font-size: 1.8rem;
            }
            #sankey-diagram {
                height: 500px;
                min-height: 500px;
            }
            .tables-grid {
                grid-template-columns: 1fr; /* Stack tables on mobile */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Fellowship Trajectories</h1>
        <p class="subtitle">Interactive visualization of career paths and program history</p>
    </header>
    
    <div class="controls-wrapper">
        <div class="control-group">
            <label for="yearFilter">Start Year</label>
            <select id="yearFilter">
                <option value="All">All Years</option>
            </select>
        </div>
        <div class="control-group">
            <label for="programFilter">Target Fellowship</label>
            <select id="programFilter">
                <option value="All">All Fellowships</option>
            </select>
        </div>
    </div>

    <div id="stats-output" class="stats-box">Initializing analytics...</div>
    
    <div class="chart-note">
        <strong>Note on "Loops":</strong> Many paths look like they loop backwards. This is because the paths between fellowships are often bidirectional (e.g., there are some people who do MATS before ERA and some who do ERA before MATS).
    </div>

    <div id="sankey-diagram"></div>
    
    <div class="tables-section">
        <h2 class="section-header">Flow Analysis Tables</h2>
        <div id="tables-container"></div>
    </div>

    <div class="tables-section">
        <h2 class="section-header">Strongest Cross-Program Links</h2>
        <div id="strongest-links-container"></div>
    </div>

    <div class="footer">
        Generated Analysis | Data Confidential
    </div>
</div>

<script>
    // --- 1. DATA SOURCE ---
    const rawText = `
Apart	2025				
Apart	2024				
Apart	2025				
Apart	2024				
Apart	2025				
Apart	2025	LASR	Apart		
Apart	2025				
Apart	2024	ARENA	Apart	AI Safety Camp	
Apart	2025				
Apart	2025				
Apart	2025				
Apart	2024				
Apart	2025	Apart	MARS		
Apart	2025	Apart	ARENA		
Apart	2024	Apart			
Apart	2025				
Apart	2024				
Apart	2024				
Apart	2025				
Apart	2024				
Apart	2025				
Apart	2025				
Apart	2025				
Apart	2024				
Apart	2024				
Apart	2024				
Apart	2024	Non-Trivial	Apart	Pivotal	
Apart	2024				
Apart	2024				
Apart	2024				
Apart	2024				
Apart	2024				
Apart	2023				
Apart	2024				
Apart	2024				
Apart	2024				
Apart	2024	SPAR	Apart	FIG	
Apart	2023	Apart	SPAR	MATS	
Apart	2024	ARENA	AI Safety Camp	Apart	MATS
Apart	2024	SPAR	Apart		
Apart	2024				
Apart	2023				
Apart	2024				
Apart	2024				
Apart	2023	Apart	ARENA		
Apart	2023	Apart	SPAR	AI Safety Camp	
Apart	2024				
Apart	2024				
Apart	2024				
Apart	2025				
Apart	2025				
Apart	2024				
ERA	2021				
ERA	2023				
ERA	2025				
ERA	2025				
ERA	2025	Apart	ERA		
ERA	2024				
ERA	2023	ERA	GovAI		
ERA	2023				
ERA	2023				
ERA	2023				
ERA	2022				
ERA	2023				
ERA	2023				
ERA	2022				
ERA	2022				
ERA	2023				
ERA	2022				
ERA	2023				
ERA	2021				
ERA	2023				
ERA	2022				
ERA	2022				
ERA	2023	Non-Trivial	ERA		
ERA	2023				
ERA	2023				
ERA	2023	ERA	SPAR		
ERA	2022	ERA	LASR	GovAI	
ERA	2023				
ERA	2022	ERA	Pivotal		
ERA	2022				
ERA	2022	MATS	ERA		
ERA	2023				
ERA	2022				
ERA	2022				
ERA	2021				
ERA	2023				
ERA	2023				
ERA	2024	AI Safety Camp	ERA		
ERA	2022				
ERA	2023	ERA	GovAI		
ERA	2021				
ERA	2025				
ERA	2025				
ERA	2025	ERA	SPAR	GovAI	
ERA	2025				
ERA	2025				
ERA	2025	Non-Trivial	FIG	ERA	
ERA	2025	ERA	GovAI		
ERA	2025				
ERA	2025				
ERA	2025				
ERA	2025				
ERA	2025				
ERA	2025				
ERA	2025	SPAR	ERA		
ERA	2025	FIG	ERA		
ERA	2023				
ERA	2025				
ERA	2025				
ERA	2025				
ERA	2025	GovAI	ERA		
ERA	2025				
ERA	2025				
ERA	2025				
ERA	2023				
ERA	2024				
ERA	2024	ERA	GovAI		
ERA	2024	ERA	GovAI		
ERA	2024	ERA	MATS		
ERA	2024	ERA	MATS		
ERA	2022	ERA	MATS		
ERA	2024	ERA	GovAI	Talos	
ERA	2024	ERA	Talos		
ERA	2022				
ERA	2021	ERA	MATS		
ERA	2024				
ERA	2024				
ERA	2024				
ERA	2025				
ERA	2024	ERA	GovAI		
ERA	2024				
ERA	2024				
ERA	2024				
ERA	2025				
ERA	2024				
ERA	2024	ERA	Pivotal		
GovAI	2023	GovAI	IAPS		
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025	ERA	GovAI		
GovAI	2025	ERA	GovAI		
GovAI	2025	FIG	GovAI		
GovAI	2025				
GovAI	2025				
GovAI	2025	Pivotal	GovAI		
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025	SPAR	ARENA	GovAI	IAPS
GovAI	2025	ERA	GovAI		
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025	GovAI	IAPS		
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025	SPAR	GovAI		
GovAI	2025				
GovAI	2025	Talos	GovAI		
GovAI	2022				
GovAI	2023				
GovAI	2024				
GovAI	2024				
GovAI	2024	Pivotal	GovAI		
GovAI	2023				
GovAI	2024	GovAI	FIG		
GovAI	2025	GovAI	ERA		
GovAI	2024				
GovAI	2025	ERA	GovAI	Talos	
GovAI	2022	MATS	GovAI		
GovAI	2025				
GovAI	2024				
GovAI	2024				
GovAI	2024	GovAI	IAPS		
GovAI	2023				
GovAI	2025				
GovAI	2020				
GovAI	2024	GovAI			
GovAI	2020				
GovAI	2024	GovAI	Pivotal		
GovAI	2024				
GovAI	2024				
GovAI	2024				
GovAI	2025				
GovAI	2024				
GovAI	2025				
GovAI	2024				
GovAI	2025				
GovAI	2024				
GovAI	2023				
GovAI	2025	FIG	GovAI	IAPS	
GovAI	2022				
GovAI	2024				
GovAI	2023				
GovAI	2025	ERA	GovAI		
GovAI	2025				
GovAI	2023	ERA	GovAI		
GovAI	2022				
GovAI	2022				
GovAI	2023				
GovAI	2023	GovAI	Asterisk		
GovAI	2025				
GovAI	2024				
GovAI	2023				
GovAI	2022				
GovAI	2025	GovAI	FIG		
GovAI	2022				
GovAI	2023				
GovAI	2023				
GovAI	2025				
GovAI	2024				
GovAI	2023				
GovAI	2025				
GovAI	2024				
GovAI	2022				
GovAI	2024				
GovAI	2023				
GovAI	2024				
GovAI	2024				
GovAI	2022				
GovAI	2024				
GovAI	2025				
GovAI	2023				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2020				
GovAI	2023				
GovAI	2023				
GovAI	2025	ERA	GovAI		
GovAI	2024				
GovAI	2022				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025				
GovAI	2025	GovAI	IAPS		
IAPS	2024				
IAPS	2024	GovAI	IAPS		
IAPS	2024				
IAPS	2024				
IAPS	2024				
IAPS	2024				
IAPS	2024				
IAPS	2024				
IAPS	2024	Astra	IAPS		
IAPS	2024	GovAI	IAPS		
IAPS	2024				
IAPS	2024	Pivotal	IAPS		
MATS	2025				
MATS	2024				
MATS	2024				
MATS	2025				
MATS	2023				
MATS	2025	MATS	Anthropic Fellow		
MATS	2024				
MATS	2024				
MATS	2025				
MATS	2025				
MATS	2023				
MATS	2025				
MATS	2025	ERA	MATS		
MATS	2025	Pivotal	MATS		
MATS	2025				
MATS	2022				
MATS	2025	SPAR	MATS		
MATS	2025				
MATS	2025	Pivotal	MATS	Talos	
MATS	2025				
MATS	2024				
MATS	2025				
MATS	2025				
MATS	2025	SPAR	MATS		
MATS	2025	SPAR	MATS		
MATS	2025	x			
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025	ARENA	MATS		
MATS	2024				
MATS	2025	ARENA	MATS		
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025	SPAR	MATS		
MATS	2025				
MATS	2025	ERA	MATS		
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025	MARS	MATS		
MATS	2025	SPAR	FIG	MATS	
MATS	2025				
MATS	2025				
MATS	2025	SPAR	MATS		
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025	AI Safety Camp	SPAR	MATS	
MATS	2025	SPAR	MATS	IAPS	
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025				
MATS	2025	MATS	SPAR		
MATS	2024				
MATS	2025				
MATS	2025	SPAR	MATS		
MATS	2024				
MATS	2024				
MATS	2023				
MATS	2025				
MATS	2022				
MATS	2025				
MATS	2025				
MATS	2024				
MATS	2023				
MATS	2024	MATS	PIBBS		
MATS	2024				
MATS	2023				
MATS	2024	ARENA	MATS		
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2025	ARENA	MATS		
MATS	2022				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024	FIG	MATS	IAPS	
MATS	2025	MATS	Tarbell		
MATS	2024				
MATS	2025				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2022				
MATS	2023				
MATS	2023				
MATS	2024				
MATS	2024	AI Safety Camp	MATS		
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2023				
MATS	2024				
MATS	2024				
MATS	2023	MATS	ARENA		
MATS	2024				
MATS	2024				
MATS	2025				
MATS	2023				
MATS	2024				
MATS	2025				
MATS	2024				
MATS	2024	ARENA	AI Safety Camp	Apart	MATS
MATS	2023	MLAB	MATS		
MATS	2023	AI Safety Camp	MATS		
MATS	2024	AI Safety Camp	ARENA	MATS	
MATS	2024				
MATS	2023				
MATS	2025				
MATS	2023				
MATS	2023				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2022				
MATS	2024				
MATS	2024	AI Safety Camp	MATS		
MATS	2022				
MATS	2024				
MATS	2023				
MATS	2024				
MATS	2024				
MATS	2023				
MATS	2024				
MATS	2024	Apart	SPAR	MATS	
MATS	2024				
MATS	2024				
MATS	2024	MATS	AI Safety Camp		
MATS	2024				
MATS	2024				
MATS	2023				
MATS	2025	LASR	MATS		
MATS	2024	MATS			
MATS	2025				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2023				
MATS	2025				
MATS	2024				
MATS	2024				
MATS	2023				
MATS	2023				
MATS	2023	AI Safety Camp	MATS		
MATS	2023				
MATS	2025	LASR	MATS		
MATS	2024				
MATS	2023				
MATS	2024				
MATS	2023				
MATS	2024	AI Safety Camp	MATS	Apart	
MATS	2024				
MATS	2023	MATS	PIBBS		
MATS	2024				
MATS	2025				
MATS	2024				
MATS	2023				
MATS	2023				
MATS	2023				
MATS	2024				
MATS	2023				
MATS	2024	SPAR	MATS		
MATS	2024				
MATS	2023				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2023	MATS	PIBBS		
MATS	2024				
MATS	2025	MARS	MATS		
MATS	2023				
MATS	2024				
MATS	2022				
MATS	2023				
MATS	2024				
MATS	2023	MATS	AI Safety Camp	SPAR	
MATS	2022				
MATS	2022	MATS	AI Safety Camp		
MATS	2022				
MATS	2025				
MATS	2025				
MATS	2024				
MATS	2024				
MATS	2024				
MATS	2025				
MATS	2022				
MATS	2024	SPAR	ARENA	MATS	
MATS	2025				
MATS	2024				
MATS	2022				
MATS	2025				
MATS	2023	MATS	SPAR	IAPS	
MATS	2023				
PIBBS	2025	MATS	PIBBS		
PIBBS	2025				
PIBBS	2025				
PIBBS	2023				
PIBBS	2023				
PIBBS	2023	MATS	PIBBS		
PIBBS	2023				
PIBBS	2023	PIBBS	Apart		
PIBBS	2024				
PIBBS	2024				
PIBBS	2023				
PIBBS	2023				
PIBBS	2024	MATS	PIBBS		
PIBBS	2022				
PIBBS	2024	PIBBS	SPAR		
PIBBS	2022				
PIBBS	2022				
PIBBS	2023				
PIBBS	2022				
PIBBS	2024				
PIBBS	2025				
PIBBS	2025				
PIBBS	2025	IRG	PIBBS		
PIBBS	2025				
PIBBS	2025				
PIBBS	2025				
PIBBS	2025				
PIBBS	2024				
PIBBS	2022				
PIBBS	2023	MATS	AI Safety Camp	PIBBS	
PIBBS	2023	PIBBS	AI Futures Fellowship		
Pivotal	2025				
Pivotal	2024	Pivotal	Tarbell		
Pivotal	2025				
Pivotal	2025				
Pivotal	2025				
Pivotal	2025	Non-Trivial	Pivotal		
Pivotal	2025				
Pivotal	2025	MARS	ARENA	Pivotal	
Pivotal	2025				
Pivotal	2025				
Pivotal	2025				
Pivotal	2025				
Pivotal	2022				
Pivotal	2021				
Pivotal	2021				
Pivotal	2024				
Pivotal	2023				
Pivotal	2021				
Pivotal	2024				
Pivotal	2022				
Pivotal	2025	Non-Trivial	Apart	Pivotal	
Pivotal	2024	Pivotal	GovAI		
Pivotal	2024	Pivotal	MATS		
Pivotal	2024	Pivotal	MATS		
Pivotal	2024	Pivotal	Talos		
Pivotal	2022	Pivotal	IAPS		
Pivotal	2022	Pivotal	Talos		
Pivotal	2025	Pivotal	IAPS		
Pivotal	2021				
Pivotal	2021				
Pivotal	2023				
Pivotal	2023				
Pivotal	2024				
Pivotal	2022	Pivotal			
Pivotal	2025				
Pivotal	2025				
Pivotal	2022	Pivotal	MATS		
Pivotal	2024				
Pivotal	2022				
Pivotal	2025				
Pivotal	2025				
Pivotal	2023				
Pivotal	2023				
Pivotal	2023				
Pivotal	2023				
Pivotal	2022				
Pivotal	2025	FIG	Pivotal		
Pivotal	2022	ERA	Pivotal		
Pivotal	2025				
Pivotal	2024				
Pivotal	2021				
Pivotal	2021				
Pivotal	2022				
Pivotal	2022				
Pivotal	2024				
Pivotal	2022				
Pivotal	2023				
Pivotal	2023				
Pivotal	2025	ARENA	Pivotal		
Pivotal	2025				
Pivotal	2024	MARS	SPAR	Pivotal	FIG
Pivotal	2025				
Pivotal	2025				
Pivotal	2024				
Pivotal	2023	MATS	Pivotal		
Pivotal	2023				
Pivotal	2022				
Pivotal	2024				
Talos	2025				
Talos	2024	SPAR	Talos		
Talos	2024				
Talos	2025	Pivotal	Talos	MATS	
Talos	2024				
Talos	2024				
Talos	2025	ARENA	Talos		
Talos	2024				
Talos	2024	Pivotal	Talos		
Talos	2025				
Talos	2024				
Talos	2024				
Talos	2025				
Talos	2025				
Talos	2025	Talos	GovAI		
Talos	2024				
Talos	2024				
Talos	2024	Pivotal	Talos		
Talos	2022				
Talos	2024				
Talos	2024	Talos	FIG		
Talos	2024	Talos	FIG		
Talos	2024				
Talos	2025				
Talos	2024				
Talos	2024				
Talos	2024	AI Safety Camp	Talos	IAPS	
Talos	2024				
Talos	2024				
Talos	2025				
Talos	2025				
Talos	2023				
Talos	2024				
Talos	2025				
Talos	2022				
Talos	2024				
Talos	2024	MATS	Talos		
Talos	2024	ERA	AIM	Talos	Mila Fellowship
Talos	2025				
Talos	2023				
Talos	2024				
Talos	2024				
Talos	2025				
Talos	2025	ERA	Talos		
Talos	2025	AI Safety Camp	Talos		
Talos	2022				
Talos	2023				
Talos	2023				
Talos	2024				
Talos	2024				
Talos	2023	Talos	Pivotal		
Talos	2024	Talos	GovAI	IAPS	
Talos	2025	Talos	IAPS		
Talos	2022	Talos	GovAI		
Talos	2024				
Talos	2024				
Talos	2025	MATS	Talos		
Talos	2024				
Talos	2024				
Talos	2024				
Talos	2023	Talos	MATS		
Talos	2025	Talos	GovAI	LawAI	
Tarbell	2024				
Tarbell	2025				
Tarbell	2025	MATS	Tarbell		
Tarbell	2025				
Tarbell	2025				
Tarbell	2025				
Tarbell	2025				
Tarbell	2025				
Tarbell	2025				
Tarbell	2024				
Tarbell	2023				
Tarbell	2023				
Tarbell	2023				
Tarbell	2023				
Tarbell	2025				
Tarbell	2023				
Tarbell	2024				
Tarbell	2023				
Tarbell	2024				
Tarbell	2024				
Tarbell	2024								
`;

    // Global variable to hold parsed data
    let parsedRows = [];

    // --- 2. LOGIC: PARSING ---
    function parseData() {
        const lines = rawText.trim().split('\n');
        const rows = [];

        lines.forEach(line => {
            if (!line.trim()) return;

            // Split by regex (Tab OR 2+ Spaces)
            const parts = line.trim().split(/\t|\s{2,}/).map(p => p.trim());

            if (parts.length < 2) return;

            const targetProgram = parts[0];
            const year = parts[1]; 

            // Get history (columns 2 onwards)
            const historyColumns = parts.slice(2);
            
            let path = historyColumns.filter(p => p !== "");

            // If no history, path is just target program
            if (path.length === 0) {
                path = [targetProgram];
            }

            rows.push({
                targetProgram,
                year,
                path
            });
        });
        return rows;
    }

    // --- 3. LOGIC: DROPDOWNS ---
    function populateFilters(rows) {
        const uniqueYears = [...new Set(rows.map(r => r.year))].sort().reverse();
        const uniquePrograms = [...new Set(rows.map(r => r.targetProgram))].sort();

        const yearSelect = document.getElementById('yearFilter');
        uniqueYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });

        const progSelect = document.getElementById('programFilter');
        uniquePrograms.forEach(prog => {
            const option = document.createElement('option');
            option.value = prog;
            option.textContent = prog;
            progSelect.appendChild(option);
        });

        // Add Listeners
        yearSelect.addEventListener('change', updateAnalysis);
        progSelect.addEventListener('change', updateAnalysis);
    }

    // --- 4. LOGIC: CHART, STATS & TABLES ---
    function updateAnalysis() {
        const yearSelect = document.getElementById('yearFilter').value;
        const progSelect = document.getElementById('programFilter').value;

        // A. Filter Data for "Strict" Views (Chart, Flow Tables)
        // This preserves the behavior of "Show me people whose Target was X"
        const yearFilteredData = parsedRows.filter(row => {
            return (yearSelect === 'All') || (row.year === yearSelect);
        });

        const fullyFilteredData = yearFilteredData.filter(row => {
            return (progSelect === 'All') || (row.targetProgram === progSelect);
        });

        // Update visuals
        updateStatsAndChart(fullyFilteredData);
        generateTables(fullyFilteredData);

        // B. Update Strongest Links (More Inclusive)
        // We pass the dataset that is filtered ONLY by year.
        // The function will handle extracting the relevant links for the selected program.
        generateStrongestLinks(yearFilteredData, progSelect); 
    }

    function updateStatsAndChart(filteredData) {
        // B. Calculate Stats & Links for Chart
        const linkCounts = new Map();
        let totalProcessed = 0;
        let hasPrior = 0;
        let hasSubsequent = 0;
        let hasOther = 0; 

        filteredData.forEach(row => {
            totalProcessed++;
            const path = row.path;
            const target = row.targetProgram;

            // Stats
            if (path.includes(target)) {
                const idx = path.indexOf(target);
                if (idx > 0) hasPrior++;
                if (idx < path.length - 1) hasSubsequent++;
            }

            // Check if path contains any program that is NOT the target program
            if (path.some(prog => prog !== target)) {
                hasOther++;
            }

            // Links
            const fullPath = ['Start', ...path, 'End'];
            for (let i = 0; i < fullPath.length - 1; i++) {
                const source = fullPath[i];
                const targetNode = fullPath[i+1];
                const key = `${source}|${targetNode}`; 
                linkCounts.set(key, (linkCounts.get(key) || 0) + 1);
            }
        });

        // C. Update Stats UI
        if (totalProcessed > 0) {
            const priorPct = ((hasPrior / totalProcessed) * 100).toFixed(1);
            const subPct = ((hasSubsequent / totalProcessed) * 100).toFixed(1);
            const otherPct = ((hasOther / totalProcessed) * 100).toFixed(1);
            
            const statsText = 
`Total Profiles Analyzed: ${totalProcessed}
• Experience BEFORE target fellowship: ${priorPct}% (${hasPrior})
• Experience AFTER target fellowship:  ${subPct}% (${hasSubsequent})
• Total with other fellowship experience: ${otherPct}% (${hasOther})`;
            
            document.getElementById('stats-output').innerText = statsText;
        } else {
            document.getElementById('stats-output').innerText = "No matching profiles found for this selection.";
        }

        // D. Prepare Plotly Data
        const uniqueNodes = new Set();
        linkCounts.forEach((value, key) => {
            const [source, target] = key.split('|');
            uniqueNodes.add(source);
            uniqueNodes.add(target);
        });
        
        const allNodes = Array.from(uniqueNodes);
        const nodeMap = new Map();
        allNodes.forEach((node, index) => nodeMap.set(node, index));

        const sourceIndices = [];
        const targetIndices = [];
        const values = [];

        linkCounts.forEach((count, key) => {
            const [sourceName, targetName] = key.split('|');
            sourceIndices.push(nodeMap.get(sourceName));
            targetIndices.push(nodeMap.get(targetName));
            values.push(count);
        });

        const dataTrace = {
            type: "sankey",
            orientation: "h",
            node: {
                pad: 30,
                thickness: 20,
                line: { color: "rgba(0,0,0,0.1)", width: 0.5 },
                label: allNodes,
                color: allNodes.map(n => n === "Start" || n === "End" ? "#95a5a6" : "#3498db"),
                arrangement: "snap"
            },
            link: {
                source: sourceIndices,
                target: targetIndices,
                value: values,
                color: "rgba(189, 195, 199, 0.4)" 
            }
        };

        const layout = {
            title: {
                text: 'Trajectory Flow',
                font: { family: 'Roboto', size: 18, color: '#2c3e50' }
            },
            font: { family: 'Roboto', size: 12 },
            height: 700, 
            autosize: true,
            margin: { l: 20, r: 20, t: 40, b: 20 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)'
        };

        const config = {
            responsive: true,
            displayModeBar: false 
        };

        Plotly.react('sankey-diagram', [dataTrace], layout, config);
    }

    // --- 5. LOGIC: TABLES GENERATION ---
    function generateTables(data) {
        const container = document.getElementById('tables-container');
        container.innerHTML = ''; // Clear previous content

        // 1. Identify all unique target programs in the filtered data
        const uniqueTargets = [...new Set(data.map(r => r.targetProgram))].sort();

        if (uniqueTargets.length === 0) {
            container.innerHTML = '<div class="empty-msg">No data available for tables.</div>';
            return;
        }

        // 2. Loop through each target program to create a section
        uniqueTargets.forEach(targetProg => {
            const progRows = data.filter(r => r.targetProgram === targetProg);
            
            // Count Before and After
            const beforeCounts = {};
            const afterCounts = {};

            progRows.forEach(row => {
                const path = row.path;
                const targetIdx = path.indexOf(targetProg);

                if (targetIdx !== -1) {
                    // BEFORE
                    const beforeArr = path.slice(0, targetIdx);
                    beforeArr.forEach(prog => {
                        beforeCounts[prog] = (beforeCounts[prog] || 0) + 1;
                    });

                    // AFTER
                    const afterArr = path.slice(targetIdx + 1);
                    afterArr.forEach(prog => {
                        afterCounts[prog] = (afterCounts[prog] || 0) + 1;
                    });
                }
            });

            const getSorted = (countsObj) => {
                return Object.entries(countsObj)
                    .sort((a, b) => b[1] - a[1]);
            };

            const sortedBefore = getSorted(beforeCounts);
            const sortedAfter = getSorted(afterCounts);

            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'program-block';

            const title = document.createElement('div');
            title.className = 'program-title';
            title.innerText = targetProg;
            sectionDiv.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'tables-grid';

            const createTableHtml = (title, dataArr) => {
                let html = `<div class="table-wrapper"><h3>${title}</h3>`;
                if (dataArr.length === 0) {
                    html += `<div class="empty-msg">None recorded</div>`;
                } else {
                    html += `<table><thead><tr><th>Fellowship</th><th class="count-col">Count</th></tr></thead><tbody>`;
                    dataArr.forEach(([name, count]) => {
                        html += `<tr><td>${name}</td><td class="count-col">${count}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                }
                html += `</div>`;
                return html;
            };

            grid.innerHTML = 
                createTableHtml(`Before ${targetProg}`, sortedBefore) +
                createTableHtml(`After ${targetProg}`, sortedAfter);

            sectionDiv.appendChild(grid);
            container.appendChild(sectionDiv);
        });
    }

    // --- 6. LOGIC: STRONGEST LINKS GENERATION ---
    function generateStrongestLinks(data, selectedProgram) {
        const container = document.getElementById('strongest-links-container');
        if (!container) return; 
        
        const pairCounts = new Map();

        // Count pairs using ALL data (subject to year filter)
        data.forEach(row => {
            const path = row.path;
            for(let i = 0; i < path.length - 1; i++) {
                const p1 = path[i];
                const p2 = path[i+1];
                
                if (p1 === p2) continue; // Skip self-loops
                
                // Sort to make direction agnostic (A->B and B->A become A|B)
                const key = [p1, p2].sort().join('|');
                pairCounts.set(key, (pairCounts.get(key) || 0) + 1);
            }
        });

        // Convert to array and sort by count descending
        const sortedPairs = Array.from(pairCounts.entries())
            .map(([key, count]) => {
                const [f1, f2] = key.split('|');
                return { f1, f2, count };
            })
            .sort((a, b) => b.count - a.count);

        // Filter for specific program if one is selected
        let displayPairs = sortedPairs;
        if (selectedProgram !== 'All') {
            displayPairs = sortedPairs.filter(p => p.f1 === selectedProgram || p.f2 === selectedProgram);
        }

        // Render
        let html = `
            <div class="program-block" style="text-align: center;">
                <div class="program-title" style="border:none;">Top Shared Trajectories (Undirected)</div>
                <p style="margin-bottom:20px; color:#666; font-size:0.9rem;">
                    Shows the total number of movements between two fellowships. 
                    <br>
                    Includes all profiles matching the Year filter (not limited by Target Fellowship selection).
                </p>
                <div style="max-width: 600px; margin: 0 auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align:right; width:45%;">Fellowship A</th>
                                <th style="width:10%; text-align:center;">↔</th>
                                <th style="text-align:left; width:45%;">Fellowship B</th>
                                <th class="count-col">Total</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        const topN = displayPairs.slice(0, 15); // Show top 15
        
        if (topN.length === 0) {
            html += `<tr><td colspan="4" style="text-align:center; padding:20px;">No links found for current selection.</td></tr>`;
        } else {
            topN.forEach(item => {
                html += `
                    <tr>
                        <td style="text-align:right; font-weight:500;">${item.f1}</td>
                        <td style="text-align:center; color:#ccc;">↔</td>
                        <td style="text-align:left; font-weight:500;">${item.f2}</td>
                        <td class="count-col" style="font-size:1.1rem;">${item.count}</td>
                    </tr>
                `;
            });
        }

        html += `</tbody></table></div></div>`;
        container.innerHTML = html;
    }

    // --- 7. INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        parsedRows = parseData(); 
        populateFilters(parsedRows); 
        updateAnalysis(); // Initial Draw
    });

</script>

</body>
</html>
